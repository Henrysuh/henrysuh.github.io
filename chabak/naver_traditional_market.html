<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전통시장 지도</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #map { width: 100%; height: 600px; margin-top: 20px; position: relative; }

    /* 내 위치 버튼 스타일 */
    #locateBtn {
      position: absolute;
      top: 90px;
      right: 30px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
  </style>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=h64ukxd2fc"></script>
</head>
<body>

<h2>전통시장 마커 지도: 내 위치, 줌버튼</h2>
<p>📍 위치 권한을 허용하면 자동 중심 이동됩니다.  
<br>🧭 [내 위치로 이동] 버튼 클릭 시 수동으로도 이동 가능</p>

<!-- ✅ 버튼은 지도 밖에 배치 -->
<button id="locateBtn" onclick="moveToCurrentLocation()">📍 내 위치로 이동</button>

<div id="map"></div>

<script>
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(36.5, 127.8),
    zoom: 7,
    zoomControl: true,
    zoomControlOptions: {
      position: naver.maps.Position.RIGHT
    }
  });

  // 지도 거리 자(스케일 바)
  map.controls[naver.maps.Position.BOTTOM_RIGHT].push(
    new naver.maps.ScaleControl()
  );

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.trim());
      return Object.fromEntries(values.map((v, i) => [headers[i], v]));
    });
  }

  fetch("traditional_market.csv")
    .then(response => response.text())
    .then(csv => {
      const data = parseCSV(csv);
      const bounds = new naver.maps.LatLngBounds();

      data.forEach(item => {
        const lat = parseFloat(item['위도']);
        const lng = parseFloat(item['경도']);
        if (isNaN(lat) || isNaN(lng)) return;

        const position = new naver.maps.LatLng(lat, lng);

        const marker = new naver.maps.Marker({
          position,
          map,
          title: item['시장명']
        });

        const infoWindow = new naver.maps.InfoWindow({
          content: `
            <div style="padding:10px; font-size:13px;">
              <strong>${item['시장명']}</strong><br>
              유형: ${item['시장유형']}<br>
              개설연도: ${item['개설연도']}<br>
              점포 수: ${item['점포수']}개<br>
              공중화장실: ${item['공중화장실 보유']}<br>
              주차장: ${item['주차장 보유']}
            </div>
          `
        });

        naver.maps.Event.addListener(marker, 'click', () => {
          infoWindow.open(map, marker);
        });

        bounds.extend(position);
      });

      map.fitBounds(bounds);
    });

  // 위치 마커 저장 (중복 방지용)
  let userLocationMarker = null;

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const userLocation = new naver.maps.LatLng(userLat, userLng);

          if (userLocationMarker) {
            userLocationMarker.setMap(null); // 이전 마커 제거
          }

          userLocationMarker = new naver.maps.Marker({
            position: userLocation,
            map: map,
            icon: {
              content: '<div style="background:#1976D2;border-radius:50%;width:12px;height:12px;"></div>',
              size: new naver.maps.Size(12, 12),
              anchor: new naver.maps.Point(6, 6)
            },
            title: "내 위치"
          });

          map.setCenter(userLocation);
          map.setZoom(13);
        },
        function(error) {
          alert("위치 정보를 가져올 수 없습니다: " + error.message);
        }
      );
    } else {
      alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
    }
  }

  // 최초 로딩 시 자동 위치 이동
  moveToCurrentLocation();
</script>

</body>
</html>
