<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì „í†µì‹œì¥ ì§€ë„</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #map { width: 100%; height: 600px; margin-top: 20px; position: relative; }

    /* ë‚´ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #locateBtn {
      position: absolute;
      top: 90px;
      right: 30px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
  </style>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=h64ukxd2fc"></script>
</head>
<body>

<h2>ì „í†µì‹œì¥ ë§ˆì»¤ ì§€ë„: ë‚´ ìœ„ì¹˜, ì¤Œë²„íŠ¼</h2>
<p>ğŸ“ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ìë™ ì¤‘ì‹¬ ì´ë™ë©ë‹ˆë‹¤.  
<br>ğŸ§­ [ë‚´ ìœ„ì¹˜ë¡œ ì´ë™] ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ë™ìœ¼ë¡œë„ ì´ë™ ê°€ëŠ¥</p>

<!-- âœ… ë²„íŠ¼ì€ ì§€ë„ ë°–ì— ë°°ì¹˜ -->
<button id="locateBtn" onclick="moveToCurrentLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™</button>

<div id="map"></div>

<script>
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(36.5, 127.8),
    zoom: 7,
    zoomControl: true,
    zoomControlOptions: {
      position: naver.maps.Position.RIGHT
    }
  });

  // ì§€ë„ ê±°ë¦¬ ì(ìŠ¤ì¼€ì¼ ë°”)
  map.controls[naver.maps.Position.BOTTOM_RIGHT].push(
    new naver.maps.ScaleControl()
  );

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.trim());
      return Object.fromEntries(values.map((v, i) => [headers[i], v]));
    });
  }

  fetch("traditional_market.csv")
    .then(response => response.text())
    .then(csv => {
      const data = parseCSV(csv);
      const bounds = new naver.maps.LatLngBounds();

      data.forEach(item => {
        const lat = parseFloat(item['ìœ„ë„']);
        const lng = parseFloat(item['ê²½ë„']);
        if (isNaN(lat) || isNaN(lng)) return;

        const position = new naver.maps.LatLng(lat, lng);

        const marker = new naver.maps.Marker({
          position,
          map,
          title: item['ì‹œì¥ëª…']
        });

        const infoWindow = new naver.maps.InfoWindow({
          content: `
            <div style="padding:10px; font-size:13px;">
              <strong>${item['ì‹œì¥ëª…']}</strong><br>
              ìœ í˜•: ${item['ì‹œì¥ìœ í˜•']}<br>
              ê°œì„¤ì—°ë„: ${item['ê°œì„¤ì—°ë„']}<br>
              ì í¬ ìˆ˜: ${item['ì í¬ìˆ˜']}ê°œ<br>
              ê³µì¤‘í™”ì¥ì‹¤: ${item['ê³µì¤‘í™”ì¥ì‹¤ ë³´ìœ ']}<br>
              ì£¼ì°¨ì¥: ${item['ì£¼ì°¨ì¥ ë³´ìœ ']}
            </div>
          `
        });

        naver.maps.Event.addListener(marker, 'click', () => {
          infoWindow.open(map, marker);
        });

        bounds.extend(position);
      });

      map.fitBounds(bounds);
    });

  // ìœ„ì¹˜ ë§ˆì»¤ ì €ì¥ (ì¤‘ë³µ ë°©ì§€ìš©)
  let userLocationMarker = null;

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const userLocation = new naver.maps.LatLng(userLat, userLng);

          if (userLocationMarker) {
            userLocationMarker.setMap(null); // ì´ì „ ë§ˆì»¤ ì œê±°
          }

          userLocationMarker = new naver.maps.Marker({
            position: userLocation,
            map: map,
            icon: {
              content: '<div style="background:#1976D2;border-radius:50%;width:12px;height:12px;"></div>',
              size: new naver.maps.Size(12, 12),
              anchor: new naver.maps.Point(6, 6)
            },
            title: "ë‚´ ìœ„ì¹˜"
          });

          map.setCenter(userLocation);
          map.setZoom(13);
        },
        function(error) {
          alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + error.message);
        }
      );
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  }

  // ìµœì´ˆ ë¡œë”© ì‹œ ìë™ ìœ„ì¹˜ ì´ë™
  moveToCurrentLocation();
</script>

</body>
</html>
